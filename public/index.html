<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
<script>
(async function() {
  const PLAY_URL = 'https://play.google.com/store/apps/details?id=com.cognifit.app&hl=en';

  function redirectToAppOrStore(token) {
    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isChrome = /Chrome/i.test(ua);
    const intentUrl =
      `intent://open?ctx=${encodeURIComponent(token)}#Intent;scheme=myapp;package=com.tuapp;end`;

    // Solo intent en Chrome Android
    if (isAndroid && isChrome) {
      const start = Date.now();
      // Intent: si la app está instalada, se abre y JS “muere” ahí
      window.location.href = intentUrl;

      // Fallback: si seguimos en la página 1.5–2s después, vamos a Play Store
      setTimeout(() => {
        const elapsed = Date.now() - start;
        if (elapsed < 2000) {
          // Probablemente no había handler / app instalada
          window.location.href = PLAY_URL;
        }
      }, 1500);
    } else {
      // Escritorio, iOS, otros navegadores → directo a Play Store
      window.location.href = PLAY_URL;
    }
  }

  const ts_click = Date.now();
  const payload = {
    ua_js: navigator.userAgent,
    language: navigator.language,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    innerW: window.innerWidth,
    innerH: window.innerHeight,
    screenW: screen.width,
    screenH: screen.height,
    dpr: window.devicePixelRatio,
    ts_click
  };

  try {
    const fp = await FingerprintJS.load();
    const result = await fp.get();
    payload.fp_id = result.visitorId;
  } catch(e){}

  try {
    const res = await fetch('/api/click', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({campaign:'android', payload})
    });

    if (!res.ok) {
      console.error('API /click no OK', res.status, res.statusText);
      redirectToAppOrStore(null); // aún así redirigimos
      return;
    }

    const { token } = await res.json();
    redirectToAppOrStore(token);
  } catch(e){
    console.error('Error en fetch /api/click:', e);
    // Si falla la API, igualmente mandamos al Play Store / app
    redirectToAppOrStore(null);
  }
})();
</script>

</body>
</html>
