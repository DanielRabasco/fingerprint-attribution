<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3.4.0/dist/fp.min.js"></script>
</head>
<body>
<script>

// ------------------------------------------
//  UTILIDADES ORIGINALES (hash, storage...)
//  (pueden quedar aunque no se usen en el FP)
// ------------------------------------------

function bufferToHex(buffer) {
  const bytes = new Uint8Array(buffer);
  let hex = '';
  for (let i = 0; i < bytes.length; i++) {
    const current = bytes[i].toString(16).padStart(2, '0');
    hex += current;
  }
  return hex;
}

function hasLocalStorage() {
  try {
    const key = '__fp_test_ls__';
    window.localStorage.setItem(key, '1');
    window.localStorage.removeItem(key);
    return 1;
  } catch (e) {
    return 0;
  }
}

function hasSessionStorage() {
  try {
    const key = '__fp_test_ss__';
    window.sessionStorage.setItem(key, '1');
    window.sessionStorage.removeItem(key);
    return 1;
  } catch (e) {
    return 0;
  }
}



function getFingerprintComponents() {
  const nav = navigator || {};
  const scr = screen || {};

  let timeZone = '';
  try {
    const opts = Intl.DateTimeFormat().resolvedOptions();
    timeZone = opts.timeZone || '';
  } catch (e) { timeZone = ''; }

  return {
    colorDepth: scr.colorDepth || 0,
    maxTouchPoints: nav.maxTouchPoints || 0,
    pixelRatio: window.devicePixelRatio || 1,
    screenHeight: scr.height || 0,
    screenWidth: scr.width || 0,
    timeZone,
    timezoneOffset: new Date().getTimezoneOffset(),
  };
}



// ----------------------------
//  CANONICAL STRING + HASH
// ----------------------------
function buildCanonicalString(components) {
  const keys = Object.keys(components).sort();
  return keys.map(k => `${k}:${String(components[k])}`).join('|');
}

async function getDeviceFingerprint() {
  const components = getFingerprintComponents();
  console.log('[FP Components]', components);
  console.log('[FP Canonical]', buildCanonicalString(components));  
  const canonical = buildCanonicalString(components);

  if (!crypto.subtle) {
    let hash = 0;
    for (let i = 0; i < canonical.length; i++) {
      hash = ((hash << 5) - hash) + canonical.charCodeAt(i);
      hash |= 0;
    }
    return `fallback_${hash}`;
  }

  const encoder = new TextEncoder();
  const data = encoder.encode(canonical);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return bufferToHex(digest);
}



// ----------------------------
//  LANZADOR + REDIRECCIÓN
// ----------------------------
(async function() {
  const ANDROID_URL = 'https://play.google.com/store/apps/details?id=com.cognifit.app';
  const IOS_URL = 'https://apps.apple.com/es/app/cognifit-test-y-juegos/id528285610';
  const WEB_FALLBACK_URL = 'https://www.cognifit.com'; // por si se abre desde escritorio u otros SO

  function redirectToAppOrStore(token) {
    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isChrome = /Chrome/i.test(ua);

    // ANDROID
    if (isAndroid) {
      // Si en algún momento tienes deep link (intent://...) con token, lo añades aquí.
      // De momento, enviamos directamente a la Play Store.
      window.location.href = ANDROID_URL;
      return;
    }

    // iOS
    if (isIOS) {
      window.location.href = IOS_URL;
      return;
    }

    // Otros dispositivos (escritorio, etc.)
    window.location.href = WEB_FALLBACK_URL;
  }

  const ts_click = Date.now();

  const payload = {
    // Estos datos siguen siendo útiles para analítica, pero NO se usan en el hash
    language: navigator.language,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,

    innerW: window.innerWidth,
    innerH: window.innerHeight,
    screenW: screen.width,
    screenH: screen.height,
    dpr: window.devicePixelRatio,
    ts_click
  };

  try {
    const fp = await getDeviceFingerprint();
    console.log('[Landing] device fingerprint:', fp);
    payload.fp_id = fp;
  } catch (e) { }

  try {
    console.log('[Landing] visitorId:', payload.fp_id);

    const res = await fetch('/api/click', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({campaign:'android', payload})
    });

    if (!res.ok) {
      redirectToAppOrStore(null);
      return;
    }

    const { token } = await res.json();
    redirectToAppOrStore(token);

  } catch (e) {
    console.error('Error en fetch /api/click:', e);
    redirectToAppOrStore(null);
  }
})();

</script>
</body>
</html>
