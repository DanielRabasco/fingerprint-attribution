<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<script>

// -----------------------------
// NORMALIZACIÓN DEL USER AGENT
// (idéntica a Angular)
// -----------------------------
function normalizeUserAgent(ua) {
  if (!ua) return "";

  // Extrae contenido entre paréntesis: "Linux; Android 12; ..." o "Linux; Android 10; K"
  const platformMatch = ua.match(/\((.*?)\)/);
  const platform = platformMatch ? platformMatch[1] : "";

  // Detecta major version de Chrome
  const chromeMatch = ua.match(/Chrome\/(\d+)/);
  const chromeVersion = chromeMatch ? `Chrome/${chromeMatch[1]}` : "";

  return `${platform}|${chromeVersion}`;
}



// -----------------------------
// STORAGE CHECKS
// -----------------------------
function hasLocalStorage() {
  try {
    const key = "__fp_test_ls__";
    localStorage.setItem(key, "1");
    localStorage.removeItem(key);
    return 1;
  } catch { return 0; }
}

function hasSessionStorage() {
  try {
    const key = "__fp_test_ss__";
    sessionStorage.setItem(key, "1");
    sessionStorage.removeItem(key);
    return 1;
  } catch { return 0; }
}



// -----------------------------
// COMPONENTES EXACTOS DEL FP
// -----------------------------
function getFingerprintComponents() {
  const nav = navigator;
  const scr = screen;

  let tz = "";
  try {
    tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
  } catch {}

  return {
    // UA estable
    userAgent: normalizeUserAgent(nav.userAgent || ""),

    language: nav.language || "",
    languages: Array.isArray(nav.languages) ? nav.languages.join(",") : "",
    maxTouchPoints: nav.maxTouchPoints || 0,

    // resolución física real (estable)
    screenWidth: scr.width || 0,
    screenHeight: scr.height || 0,
    pixelRatio: window.devicePixelRatio || 1,

    timezoneOffset: new Date().getTimezoneOffset(),
    timeZone: tz,

    cookieEnabled: nav.cookieEnabled ? 1 : 0,
    localStorage: hasLocalStorage(),
    sessionStorage: hasSessionStorage()
  };
}



// -----------------------------
// HASH
// -----------------------------
function buildCanonicalString(obj) {
  return Object.keys(obj)
    .sort()
    .map(k => `${k}:${obj[k]}`)
    .join("|");
}

async function getDeviceFingerprint() {
  const components = getFingerprintComponents();
  const canonical = buildCanonicalString(components);

  if (!crypto.subtle) {
    let hash = 0;
    for (let i = 0; i < canonical.length; i++) {
      hash = (hash << 5) - hash + canonical.charCodeAt(i);
      hash |= 0;
    }
    return `fallback_${hash}`;
  }

  const encoded = new TextEncoder().encode(canonical);
  const digest = await crypto.subtle.digest("SHA-256", encoded);

  const bytes = new Uint8Array(digest);
  return [...bytes].map(b => b.toString(16).padStart(2, "0")).join("");
}



// -----------------------------
// MAIN
// -----------------------------
(async function () {
  const fp = await getDeviceFingerprint();
  console.log("[Landing] FP:", fp);

  const payload = {
    fp_id: fp,
    ua_js: normalizeUserAgent(navigator.userAgent || ""),
    language: navigator.language || "",
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "",
    screenW: screen.width,
    screenH: screen.height,
    dpr: devicePixelRatio
  };

  try {
    const res = await fetch("/api/click", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ campaign: "android", payload })
    });

    const { token } = await res.json();

    // redirección temporal
    window.location.href = "https://google.com";

  } catch (e) {
    console.error("Error:", e);
    window.location.href = "https://google.com";
  }
})();

</script>
</body>
</html>
