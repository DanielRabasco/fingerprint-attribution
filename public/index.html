<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3.4.0/dist/fp.min.js"></script>
</head>
<body>
<script>

// -----------------------------
//  EXTRACCIÓN DEL UA ESTABLE
// -----------------------------
function getStableUserAgent() {
  const ua = navigator.userAgent || "";

  const base = "Mozilla/5.0 (Linux; Android)";
  const webkit = "AppleWebKit/537.36 (KHTML, like Gecko)";
  const safari = "Mobile Safari/537.36";

  return `${base} ${webkit} ${safari}`;
}



// ------------------------------------------
//  UTILIDADES ORIGINALES (hash, storage...)
//  (pueden quedar aunque no se usen en el FP)
// ------------------------------------------

function bufferToHex(buffer) {
  const bytes = new Uint8Array(buffer);
  let hex = '';
  for (let i = 0; i < bytes.length; i++) {
    const current = bytes[i].toString(16).padStart(2, '0');
    hex += current;
  }
  return hex;
}

function hasLocalStorage() {
  try {
    const key = '__fp_test_ls__';
    window.localStorage.setItem(key, '1');
    window.localStorage.removeItem(key);
    return 1;
  } catch (e) {
    return 0;
  }
}

function hasSessionStorage() {
  try {
    const key = '__fp_test_ss__';
    window.sessionStorage.setItem(key, '1');
    window.sessionStorage.removeItem(key);
    return 1;
  } catch (e) {
    return 0;
  }
}



// ----------------------------
//  COMPONENTES DEL FINGERPRINT
//  (solo parámetros muy estables)
// ----------------------------
function getFingerprintComponents() {
  const nav = navigator || {};
  const scr = screen || {};

  let timeZone = '';
  try {
    const opts = Intl.DateTimeFormat().resolvedOptions();
    timeZone = opts.timeZone || '';
  } catch (e) { timeZone = ''; }

  return {
    // SOLO la parte estable del UA (normalizado)
    stableUserAgent: getStableUserAgent(),

    // Plataforma / dispositivo
    platform: nav.platform || '',

    // Pantalla (dimensiones físicas)
    screenWidth: scr.width || 0,
    screenHeight: scr.height || 0,
    colorDepth: scr.colorDepth || 0,

    // Escalado
    pixelRatio: window.devicePixelRatio || 1,

    // Zona horaria
    timezoneOffset: new Date().getTimezoneOffset(),
    timeZone,

    // Opcional pero bastante estable
    maxTouchPoints: nav.maxTouchPoints || 0
  };
}



// ----------------------------
//  CANONICAL STRING + HASH
// ----------------------------
function buildCanonicalString(components) {
  const keys = Object.keys(components).sort();
  return keys.map(k => `${k}:${String(components[k])}`).join('|');
}

async function getDeviceFingerprint() {
  const components = getFingerprintComponents();
  const canonical = buildCanonicalString(components);

  if (!crypto.subtle) {
    let hash = 0;
    for (let i = 0; i < canonical.length; i++) {
      hash = ((hash << 5) - hash) + canonical.charCodeAt(i);
      hash |= 0;
    }
    return `fallback_${hash}`;
  }

  const encoder = new TextEncoder();
  const data = encoder.encode(canonical);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return bufferToHex(digest);
}



// ----------------------------
//  LANZADOR + REDIRECCIÓN
// ----------------------------
(async function() {
  const PLAY_URL = 'https://google.com';

  function redirectToAppOrStore(token) {
    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isChrome = /Chrome/i.test(ua);

    const intentUrl =
      `intent://open?ctx=${encodeURIComponent(token)}#Intent;scheme=myapp;package=com.tuapp;end`;

    // Desactivado para pruebas
    window.location.href = PLAY_URL;
  }

  const ts_click = Date.now();

  const payload = {
    // AHORA usa el UA ESTABLE (normalizado)
    ua_js: getStableUserAgent(),

    // Estos datos siguen siendo útiles para analítica, pero NO se usan en el hash
    language: navigator.language,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,

    innerW: window.innerWidth,
    innerH: window.innerHeight,
    screenW: screen.width,
    screenH: screen.height,
    dpr: window.devicePixelRatio,
    ts_click
  };

  try {
    const fp = await getDeviceFingerprint();
    console.log('[Landing] device fingerprint:', fp);
    payload.fp_id = fp;
  } catch (e) { }

  try {
    console.log('[Landing] visitorId:', payload.fp_id);

    const res = await fetch('/api/click', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({campaign:'android', payload})
    });

    if (!res.ok) {
      redirectToAppOrStore(null);
      return;
    }

    const { token } = await res.json();
    redirectToAppOrStore(token);

  } catch (e) {
    console.error('Error en fetch /api/click:', e);
    redirectToAppOrStore(null);
  }
})();

</script>
</body>
</html>
